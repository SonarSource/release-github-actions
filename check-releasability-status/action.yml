name: 'Check releasability status'
description: 'Checks the Releasability Status on the specified branch'
author: 'SonarSource'

inputs:
  github-token:
    description: 'The GitHub token for API calls.'
    required: true
    default: ${{ github.token }}
  branch:
    description: 'The branch from which to check the releasability status.'
    required: false
    default: 'master'
  with-optional-checks:
    description: 'Whether to also check that the description does not contain "failed optional checks".'
    required: false
    default: 'true'

runs:
  using: 'composite'
  steps:
    - name: Check releasability status
      shell: bash
      env:
        GITHUB_TOKEN: ${{ inputs.github-token }}
      run: |
        echo "Checking Releasability status on ${{ inputs.branch }} branch..."
        
        # Get the status for the specified branch
        STATUS_RESPONSE=$(gh api "/repos/${{ github.repository }}/commits/${{ inputs.branch }}/status" 2>/dev/null)
        
        if [ $? -ne 0 ]; then
          echo "❌ Failed to get status information for ${{ inputs.branch }} branch"
          exit 1
        fi
        
        # Find the Releasability status
        RELEASABILITY_STATE=$(echo "$STATUS_RESPONSE" | jq -r '.statuses[] | select(.context == "Releasability") | .state')
        RELEASABILITY_DESCRIPTION=$(echo "$STATUS_RESPONSE" | jq -r '.statuses[] | select(.context == "Releasability") | .description')
        
        if [ -z "$RELEASABILITY_STATE" ] || [ "$RELEASABILITY_STATE" = "null" ]; then
          echo "❌ Could not find Releasability status on ${{ inputs.branch }} branch"
          exit 1
        fi
        
        echo "Found Releasability status: $RELEASABILITY_STATE"
        echo "Description: $RELEASABILITY_DESCRIPTION"
        
        # Check if state is success
        if [ "$RELEASABILITY_STATE" != "success" ]; then
          echo "❌ Releasability status is not success: $RELEASABILITY_STATE"
          exit 1
        fi
        
        # Check optional failures if requested
        if [ "${{ inputs.with-optional-checks }}" = "true" ]; then
          if echo "$RELEASABILITY_DESCRIPTION" | grep -i "failed optional checks" > /dev/null; then
            echo "❌ Releasability status contains 'failed optional checks' in description"
            exit 1
          fi
        fi
        
        echo "✅ Releasability status check passed"
