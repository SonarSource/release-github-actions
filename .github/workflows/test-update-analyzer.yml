name: Test Update Analyzer Action

on:
  workflow_call:
  pull_request:
    paths:
      - 'update-analyzer/**'
      - '.github/workflows/test-update-analyzer.yml'
  push:
    branches:
      - branch-*
    paths:
      - 'update-analyzer/**'
      - '.github/workflows/test-update-analyzer.yml'
  workflow_dispatch:

jobs:
  validation-tests:
    name: Test Input Validation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Test Without Required Inputs
        id: test-no-inputs
        uses: ./update-analyzer
        with:
          release-version: ""
          ticket-key: ""
          plugin-name: ""
          secret-name: ""
        continue-on-error: true

      - name: Verify Missing Inputs Failure
        if: steps.test-no-inputs.outcome == 'success'
        run: |
          echo "✗ Action should have failed when required inputs are missing"
          exit 1

      - name: Confirm Missing Inputs Failure
        if: steps.test-no-inputs.outcome == 'failure'
        run: |
          echo "✓ Action correctly failed when required inputs are missing"

      - name: Test Invalid Ticket Format
        id: test-invalid-ticket
        uses: ./update-analyzer
        with:
          release-version: "1.0.0.1"
          ticket-key: "INVALID-123"
          plugin-name: "test"
          secret-name: "test-secret"
        continue-on-error: true

      - name: Verify Invalid Ticket Failure
        if: steps.test-invalid-ticket.outcome == 'success'
        run: |
          echo "✗ Action should have failed with invalid ticket format"
          exit 1

      - name: Confirm Invalid Ticket Failure
        if: steps.test-invalid-ticket.outcome == 'failure'
        run: |
          echo "✓ Action correctly failed with invalid ticket format"

      - name: Summary of Validation Tests
        run: |
          echo "================================"
          echo "Validation Test Results Summary:"
          echo "================================"
          echo "✓ Missing inputs validation: ${{ steps.test-no-inputs.outcome == 'failure' && 'PASS' || 'FAIL' }}"
          echo "✓ Invalid ticket format validation: ${{ steps.test-invalid-ticket.outcome == 'failure' && 'PASS' || 'FAIL' }}"
          echo "================================"

  input-parameter-tests:
    name: Test Input Parameters
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Test Valid SONAR Ticket
        id: test-sonar-ticket
        uses: ./update-analyzer
        with:
          release-version: "1.0.0.1"
          ticket-key: "SONAR-12345"
          plugin-name: "test"
          secret-name: "test-secret"
        continue-on-error: true

      - name: Test Valid SC Ticket
        id: test-sc-ticket
        uses: ./update-analyzer
        with:
          release-version: "1.0.0.1"
          ticket-key: "SC-12345"
          plugin-name: "test"
          secret-name: "test-secret"
        continue-on-error: true

      - name: Test Plugin Artifacts Parameter
        id: test-plugin-artifacts
        uses: ./update-analyzer
        with:
          release-version: "1.0.0.1"
          ticket-key: "SONAR-12345"
          plugin-name: "jvm"
          plugin-artifacts: "java,kotlin,scala"
          secret-name: "test-secret"
        continue-on-error: true

      - name: Test Optional Parameters
        id: test-optional-params
        uses: ./update-analyzer
        with:
          release-version: "1.0.0.1"
          ticket-key: "SONAR-12345"
          plugin-name: "test"
          secret-name: "test-secret"
          base-branch: "develop"
          draft: "true"
          reviewers: "user1,user2"
          pull-request-body: "Test PR body"
        continue-on-error: true

      - name: Test With Special Characters in Inputs
        id: test-special-chars
        uses: ./update-analyzer
        with:
          release-version: '1.0.0.1'
          ticket-key: "SONAR-12345"
          plugin-name: 'test-plugin'
          plugin-artifacts: 'java,kotlin,"scala"'
          secret-name: "test-secret"
          pull-request-body: |
            Update analyzer to version 1.0.0.1

            ### Changes
            - Fix issue with "quotes" in parser
            - Handle 'single quotes' correctly
            - Improve "double quoted" strings
        continue-on-error: true

      - name: Verify Parameter Tests
        run: |
          echo "Input parameter test results:"
          echo "SONAR ticket test outcome: ${{ steps.test-sonar-ticket.outcome }}"
          echo "SC ticket test outcome: ${{ steps.test-sc-ticket.outcome }}"
          echo "Plugin artifacts test outcome: ${{ steps.test-plugin-artifacts.outcome }}"
          echo "Optional parameters test outcome: ${{ steps.test-optional-params.outcome }}"
          echo "Special characters test outcome: ${{ steps.test-special-chars.outcome }}"

          # All tests are expected to fail due to missing vault access
          # We're testing that the parameters are accepted and don't cause syntax errors
          echo "✓ All parameter tests completed without syntax errors"
          echo "✓ Action accepts all valid input parameter combinations"
          echo "✓ Action handles quotes and special characters in inputs"
